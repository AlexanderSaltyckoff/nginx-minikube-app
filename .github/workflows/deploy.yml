name: Deploy to Minikube

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build and push Docker image
      run: |
        # –°–æ–±–∏—Ä–∞–µ–º —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Ç–µ–≥–æ–º (—Ö—ç—à –∫–æ–º–º–∏—Ç–∞) –∏ latest
        docker build -t alexandersaltyckoff/nginx-app:$GITHUB_SHA -t alexandersaltyckoff/nginx-app:latest .
        
        # –ü—É—à–∏–º –æ–±–∞ —Ç–µ–≥–∞
        docker push alexandersaltyckoff/nginx-app:$GITHUB_SHA
        docker push alexandersaltyckoff/nginx-app:latest
        
    - name: Deploy to Kubernetes
      run: |
        # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é (Kubernetes —É–≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ)
        kubectl set image deployment/nginx-app nginx=alexandersaltyckoff/nginx-app:$GITHUB_SHA
        
        # –ñ–¥–µ–º rolling update
        kubectl rollout status deployment/nginx-app --timeout=5m
        
    - name: Verify deployment
      run: |
        echo "‚úÖ Deployment completed!"
        kubectl get pods
        echo "üîÑ Using image: alexandersaltyckoff/nginx-app:$GITHUB_SHA"
