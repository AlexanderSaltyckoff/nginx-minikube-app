name: Deploy to Minikube

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v4
      
    # –®–∞–≥ 2: –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker –æ–±—Ä–∞–∑ —Å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    - name: Build and push Docker image
      run: |
        # –°–æ–±–∏—Ä–∞–µ–º —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Ç–µ–≥–æ–º (—Ö—ç—à –∫–æ–º–º–∏—Ç–∞) –∏ latest
        docker build -t alexandersaltyckoff/nginx-app:$GITHUB_SHA -t alexandersaltyckoff/nginx-app:latest .
        
        # –ü—É—à–∏–º –æ–±–∞ —Ç–µ–≥–∞
        docker push alexandersaltyckoff/nginx-app:$GITHUB_SHA
        docker push alexandersaltyckoff/nginx-app:latest
        
    # –®–∞–≥ 3: –î–µ–ø–ª–æ–∏–º –í–°–ï –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –≤ Kubernetes
    - name: Deploy to Kubernetes
      run: |
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ –ø–∞–ø–∫–∏ k8s
        kubectl apply -f k8s/
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è rolling update
        kubectl rollout status deployment/nginx-app --timeout=5m
        
    # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–ø–ª–æ–π
    - name: Verify deployment
      run: |
        echo "‚úÖ Deployment completed successfully!"
        echo "üì¶ Current pods:"
        kubectl get pods -o wide
        echo "üåê Services:"
        kubectl get services
        echo "üîÑ Using image version: $GITHUB_SHA"
