name: Deploy to Minikube

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    # Ğ¨Ğ°Ğ³ 1: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Ğ¨Ğ°Ğ³ 2: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¸ Ğ¿ÑƒÑˆĞ¸Ğ¼ Docker Ğ¾Ğ±Ñ€Ğ°Ğ· Ñ Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
    - name: Build and push Docker image
      run: |
        # Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ‚ĞµĞ³Ğ¾Ğ¼ (Ñ…ÑÑˆ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°) Ğ¸ latest
        docker build -t alexandersaltyckoff/nginx-app:$GITHUB_SHA -t alexandersaltyckoff/nginx-app:latest .
        
        # ĞŸÑƒÑˆĞ¸Ğ¼ Ğ¾Ğ±Ğ° Ñ‚ĞµĞ³Ğ°
        docker push alexandersaltyckoff/nginx-app:$GITHUB_SHA
        docker push alexandersaltyckoff/nginx-app:latest
        
    # Ğ¨Ğ°Ğ³ 3: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ’Ğ¡Ğ• Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ñ‹ Ğ² Kubernetes
    - name: Deploy to Kubernetes
      run: |
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ²ÑĞµ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ñ‹ Ğ¸Ğ· Ğ¿Ğ°Ğ¿ĞºĞ¸ k8s
        kubectl apply -f k8s/
        
        # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ rolling update
        kubectl rollout status deployment/nginx-app --timeout=5m
        
    # Ğ¨Ğ°Ğ³ 4: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
    - name: Verify deployment
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "ğŸ“¦ Current pods:"
        kubectl get pods -o wide
        echo "ğŸŒ Services:"
        kubectl get services
        echo "ğŸ”„ Using image version: $GITHUB_SHA"
        
    # Ğ¨Ğ°Ğ³ 5: Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ port-forward Ğ² Ñ„Ğ¾Ğ½Ğµ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    - name: Start port-forward
      run: |
        # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğ¹ port-forward ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        pkill -f "kubectl port-forward" || true
        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ² Ñ„Ğ¾Ğ½Ğµ
        nohup kubectl port-forward svc/nginx-service 8888:80 --address 0.0.0.0 > /tmp/port-forward.log 2>&1 &
        echo "ğŸ”— Port-forward started on :8888"
