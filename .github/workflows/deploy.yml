name: Deploy to Minikube

on:
  push:
    branches: [ main ]
  workflow_dispatch:    # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø–æ –∫–Ω–æ–ø–∫–µ
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      version:
        description: 'Deploy specific version (git SHA)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: self-hosted
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: http://192.168.1.137:8888  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π IP
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout code
      uses: actions/checkout@v4
      
    # –®–∞–≥ 2: –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º Docker –æ–±—Ä–∞–∑
    - name: Build and push Docker image
      run: |
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è –æ–±—Ä–∞–∑–∞
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="$GITHUB_SHA"
        fi
        
        echo "üî® Building image version: $VERSION"
        
        docker build -t alexandersaltyckoff/nginx-app:$VERSION -t alexandersaltyckoff/nginx-app:latest .
        docker push alexandersaltyckoff/nginx-app:$VERSION
        docker push alexandersaltyckoff/nginx-app:latest
        
    # –®–∞–≥ 3: –î–µ–ø–ª–æ–∏–º –≤ Kubernetes
    - name: Deploy to Kubernetes
      run: |
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
        kubectl apply -f k8s/
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π –æ–±—Ä–∞–∑ –¥–µ–ø–ª–æ–∏—Ç—å
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
          kubectl set image deployment/nginx-app nginx=alexandersaltyckoff/nginx-app:${{ github.event.inputs.version }}
          echo "üöÄ Deploying specific version: ${{ github.event.inputs.version }}"
        else
          kubectl set image deployment/nginx-app nginx=alexandersaltyckoff/nginx-app:$GITHUB_SHA
          echo "üöÄ Deploying latest commit: $GITHUB_SHA"
        fi
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è rolling update
        kubectl rollout status deployment/nginx-app --timeout=5m
        
    # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–ø–ª–æ–π
    - name: Verify deployment
      run: |
        echo "‚úÖ Deployment to ${{ github.event.inputs.environment || 'production' }} completed successfully!"
        echo "üì¶ Current pods:"
        kubectl get pods -o wide
        echo "üåê Services:"
        kubectl get services
        echo "üîÑ Deployed version: $GITHUB_SHA"
